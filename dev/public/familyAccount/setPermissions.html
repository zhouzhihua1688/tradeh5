<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>设置权限</title>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../base/css/base.css">
    <script type="text/javascript" src="../base/js/baseHead.js"></script>
    <script type="text/javascript" src="../base/js/needLogin.js"></script>
    <script>
        // 相对字体大小设置
        var oHtml = document.documentElement;
        getFont();
        window.onresize = function () {
            getFont();
        }

        function getFont() {
            var screenWidth = oHtml.clientWidth;
            if (screenWidth <= 320) {
                oHtml.style.fontSize = '17.06px';
            } else if (screenWidth >= 750) {
                oHtml.style.fontSize = '40px';
            } else {
                oHtml.style.fontSize = screenWidth / (750 / 40) + 'px';
            }
        }
    </script>
    <style>
        body, html {
            background: #f6f6f6;
        }

        body {
            left: 0%;
            right: 0%;
            font: 14px 'PingFang SC', 'Microsoft YaHei', Tahoma, Arial, sans-serif;
        }

        button {
            outline: none;
        }

        /* 图片自适应 */
        img {
            width: 100%;
            height: auto;
            width: auto \9; /* ie8 */
            -ms-interpolation-mode: bicubic; /*为了照顾ie图片缩放失真*/
            border: none;
            vertical-align: top;
            outline: none;
            display: block;
            border-radius: 50%;
        }

        .main {
            width: 100%;
            height: 100%;
        }

        .tipText {
            font-size: 0.6rem;
            color: #666;
            padding: 0.75rem 0 0 0.75rem;
            display: inline-block;
        }

        .tipText img {
            width: 0.75rem;
            height: 0.75rem;
            display: inline-block;
            vertical-align: top;
            margin-left: 0.25rem;
        }

        .list {
            width: 17.25rem;
            height: 4.0rem;
            background: #fff;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.2rem;
            margin-top: 0.5rem;
        }

        .list div {
            width: 22%;
        }

        .list div:nth-of-type(1) {
            margin-left: 0.75rem;
        }

        .list div:nth-of-type(2) {
            width: 30%;
            text-align: left;
            margin-left: 0.75rem;
        }

        .list div:nth-of-type(3) {
            width: 80%;
            text-align: right;
        }

        .list div .img img {
            width: 3.0rem;
            height: 3.0rem;
            border-radius: 1.25rem;
        }

        .list div .one {
            font-size: 0.85rem;
            color: #000;
            display: inline-block;
        }

        .list div .one img {
            width: 0.8rem;
            height: 0.8rem;
            display: inline-block;
            vertical-align: middle;
            margin-top: -0.25rem;
            margin-left: 0.5rem;
        }

        .list div .two {
            font-size: 0.65rem;
            color: #666;
            margin-top: 0.35rem;
        }

        .list div .three {
            /*  width: 2.5rem;
             height: 1rem;
             border-radius: 50px 50px;
             text-align: center;
             line-height:1rem;
             font-size: 0.65rem;
             color: #fb5c5f; */
            /*background: #fb5c5f;*/
            /* border:1px solid red; */
            /* margin-right:0.5rem;
            display: inline-block; */
        }

        .list div .three {
            width: 2.5rem;
            height: 1rem;
            border-radius: 50px 50px;
            text-align: center;
            line-height: 1rem;
            font-size: 0.65rem;
            color: #fb5c5f;
            margin-right: 0.5rem;
            display: inline-block;
            /*border: 1px solid red;*/
            background: #ffefef;
        }

        .list div .three .border {
            border: 1px solid red;
        }

        .list div .four {
            font-size: 0.65rem;
            color: #666;
            margin-right: 0.75rem;
            margin-top: 0.25rem;
        }

        .manage {
            width: 4.25rem;
            height: 1.25rem;
            background: #fff;
            border-radius: 50px 50px;
            margin: 0 auto;
            margin-top: 1.25rem;
            text-align: center;
        }

        .manage div {
            font-size: 0.65rem;
            color: #148ce6;
            display: inline-block;
            line-height: 1.25rem
        }

        .manage div img {
            width: 0.35rem;
            height: 0.6rem;
            display: inline-block;
            vertical-align: middle;
            margin-top: -0.1rem;
            margin-left: 0.25rem;
        }

        .tips {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.507);
            font-size: .7rem;
        }

        .tips > div {
            background: #fff;
            position: absolute;
            left: 10%;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            padding: .5rem .75rem 0;
            border-radius: .2rem;
        }

        .tips .tips_text {
            padding: .75rem;
            text-align: center;
            color: #000;
        }

        .tips .button {
            display: flex;
            align-items: center;
            text-align: center;
            border-top: 1px solid #eee;
            margin-top: .75rem;
        }

        .tips .button span {
            margin-top: .25rem;
            padding: .625rem 0;
            margin-bottom: .25rem;
            width: 100%;
            color: #1370fa;
        }

        .tips .button span:nth-of-type(1) {
            /* border-right: 1px solid #eee; */
        }

        .tips .name {
            width: 13.25rem;
            height: 1.5rem;
            border: 1px solid #eee;
            margin: 0 auto;
            border-radius: 0.125rem;
        }

        .tips .name input {
            width: 13.25rem;
            height: 1.5rem;
        }

        input::-webkit-input-placeholder {
            color: #999;
        }

        input::-moz-input-placeholder {
            color: #999;
        }

        input::-ms-input-placeholder {
            color: #999;
        }

        footer {
            position: fixed;
            width: 100%;
            left: 0;
            bottom: 0;
            background-color: #fff;
            font-size: .85rem;
        }

        footer ul {
            color: #fe5a5b;
            display: flex;
            display: -webkit-flex;
        }

        footer ul li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 0.025rem solid #fff;
        }

        footer ul li:nth-of-type(1) {
            width: 100%;
        }

        footer ul li:last-child {
            width: 100%;
            background: #0757b2;
            border-right: none;
        }

        footer ul li a {
            height: 2.5rem;
            text-align: center;
            line-height: 2.5rem;
            color: #fff;
            font-size: 0.85rem;
        }

        footer ul li a {
            display: block;
        }

        .mobileSelect .content {
            width: 95%;
            display: block;
            position: fixed;
            z-index: 889;
            color: black;
            -webkit-transition: all 0.4s;
            transition: all 0.4s;
            bottom: 1rem;
            left: 0.5rem;
            background: white;
            border-radius: 10px;
        }

        .mobileSelect-show .content {
            bottom: 100px;
        }

        .giftlist .title {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 2.5rem !important;
            line-height: 2.5rem !important;
        }

        .giftlist .title .cancel {
            text-indent: 0.75rem;
            font-size: 0.7rem;
        }

        .giftlist .title .setPower {
            color: #000;
            font-size: 0.7rem
        }

        .giftlist .title .left {
            text-indent: 0.75rem;
            font-size: 0.7rem;
            color: #000;
        }

        .giftlist .title .finish, .giftlist .title .right {
            margin-right: 0.75rem;
            font-size: 0.7rem
        }

        .giftlist .title .right img {
            width: 0.75rem;
            height: 0.75rem;
        }

        .layer0 {
            bottom: 0.5rem;
        }
    </style>
</head>
<body>
<div class="main">
    <div class="tipText">您可设置家庭成员在“<span class="textTips">为Luke存零花钱</span>”计划下的权限<img src="img/tanhao.png" alt=""
                                                                                      id="showTip"></div>
    <div class="all">

    </div>
    <!-- 浮层 -->
    <div class="mask" style="display:none"></div>
    <div class="layer0 animated slideInUp" style="display:none">
        <div class="giftlist">
            <div class="title">
                <span class="cancel">取消</span>
                <span class="setPower"></span>
                <span class="finish">完成</span>
            </div>
            <div class="title">
                <span class="left">仅查看</span>
                <span class="right">
                <img src="img/radio.png" alt="" class="active" data="1">
                </span>
            </div>
            <div class="title">
                <span class="left">可投资</span>
                <span class="right">
                    <img src="img/radio.png" alt="" class="active" data="3">
                </span>
            </div>
            <div class="title">
                <span class="left">无权限</span>
                <span class="right">
                    <img src="img/radio.png" alt="" class="active" data="0">
                </span>
            </div>
        </div>

        <!--  <div class="close">
             <a href="javascript:;" style="color:#0070fa;font-size:0.75rem" >取消</a>
         </div>  -->
    </div>
    <!-- 弹窗 -->
    <div class="tips" style="display:none">
        <div>
            <p class="tips_text">"仅查看"表示家庭成员可查看该计划下的资产，但不能投资。"可投资"表示家庭成员可向该计划进行投资。</p>
            <a href="javascript:;"><p class="button close"><span>我知道了</span></p></a>
        </div>
    </div>
</div>
<script type="text/javascript" src="../base/js/lib/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../base/js/utils.js"></script>
<script>

    //start 当前用户的custno
    var userInfo = utils.getSession(utils.userInfo);
    var custNo = userInfo.custNo;
    //end  当前用户的custno
    var accountId = utils.getUrlParam("accountId");
    var teamId = '';

    //是否开启亲情宝 获取teamId
    function getAccount() {
        utils.get('/sfs/v1/accounts/is-open?version=6.6', null, function (result) {
            if (result.returnCode == 0) {
                if (result.body.isOpen) {
                    teamId = result.body.teamId

                }
            }
        });
    }

    var permissionVoList = [];
    var protectItemId;
    var protectItemType;
    function permission() {
        utils.get('/sfs/v1/permission/item?protectItemType=1' + '&protectItemId=' + accountId, null, function (result) {
            if (result.returnCode == 0) {
                var htm = '';
                $(".textTips").text(result.body.planName);
                protectItemId=result.body.protectItemId  //获取ID
                protectItemType=result.body.protectItemType  //获取type
                result.body.limitMemberAndPermissionVoList.map(function (itemPermission) {   //匹配设置相应文本
                    if (itemPermission.permission == '0') {
                        itemPermission.permissionText = "无权限";
                    }
                    else if (itemPermission.permission == '1') {
                        itemPermission.permissionText = "仅查看";
                    } else if (itemPermission.permission == '3') {
                        itemPermission.permissionText = "可投资";
                    }
                    return permissionVoList = result.body.limitMemberAndPermissionVoList
                });

                // $.each(permissionVoList, function (key, value) { //遍历这个数组，调用匿名函数进行处理
                //     var list = $('<div class="list"><div class="img"><img src="img/family.png" alt=""></div><div><p class="one"><span class="name">' + permissionVoList[key].memberRoleName + '</p>' +
                //         '<p class="two">'+permissionVoList[key].memberNameDisplay+'</p>' +
                //         '</div><div><p class="three">'+permissionVoList[key].permissionText+'</div></div>'); //创建一个节点
                //     $(".all").append(list); //将这个节点加入到table中
                // })
                permissionVoList.forEach(function (item) {
                    if(item.permission == '0'){
                        htm += '<div class="list"><div class="img"><img src="'+item.avatarImage+'" alt=""></div><div><p class="one"><span class="name">' + item.memberRoleName + '</p>' +
                            '<p class="two">' + item.memberNameDisplay + '</p>' +
                            '</div><div><p class="three" style="background: #eee;color:#999">' + item.permissionText + '</p></div></div>'
                    }else{
                        htm += '<div class="list"><div class="img"><img src="'+item.avatarImage+'" alt=""></div><div><p class="one"><span class="name">' + item.memberRoleName + '</p>' +
                            '<p class="two">' + item.memberNameDisplay + '</p>' +
                            '</div><div><p class="three">' + item.permissionText + '</p></div></div>'
                    }

                })
                $(".all").html(htm);
            }
        });
    }

$(function () {
        getAccount();
        permission();
        // for (var i = 0; i<5; i++) {
        // 	$(".all").append('<div class="list"><div><img src="" alt=""></div><div><p class="one">孔子</p><p class="two">圣人啊</p></div><div><p class="three">'+arr[i]+'</p></div></div>')
        // }
        // var arr = ["111", "222", "333", "444", "555",];
        // $.each(arr, function (key, value) { //遍历这个数组，调用匿名函数进行处理
        //     var list = $('<div class="list"><div class="img"><img src="img/family.png" alt=""></div><div><p class="one"><span class="name">' + arr[key] + '</p><p class="two">孔人啊</p></div><div><p class="three"></div></div>'); //创建一个节点
        //     $(".all").append(list); //将这个节点加入到table中
        // })
        // 自定义角色
        //     var _that;
        //     $(".setRole").click(function(index,event) {
        //       $(".tips input").val("");   //每次点击清空残留记录的值
        //        _that = $(".setRole").index(this);  //点击是第几个
        //        $(".tips").show();         //显示弹窗
        //     });
        //     $(".define").click(function(){
        //       $(this).parents().find(".all .name").eq(_that).text($(".tips input").val())  //赋值
        //       $(".tips").hide();        //关闭弹窗
        //     })

        var _that;
        var html;
        var Number;
        var PermissionList=[];
        // 点击获取的是当前哪个用户
        $(".all").on('click', '.list', function (index, event) {     //事件委托获取节点点击事件
            _that = $(".list").index(this);  //点击是第几个
            html = $(".name").eq(_that).text();
            $(".setPower").html("设置" + html + "的权限");

            //初始化权限选中显示
            $(".giftlist .right .active").each(function(index,el){
                if(permissionVoList[_that].permission==$(el).attr("data")){
                    $(this).attr('src','img/active.png').parents().siblings().find(".active").attr('src', 'img/radio.png')//选中初始化
                }
            })
            // start为修改添加值作处理
            PermissionList=[
                {
                    limitItemId:permissionVoList[_that].limitItemId,
                    limitItemType:permissionVoList[_that].limitItemType,
                }
            ]
            // end为修改添加值作处理

            $(".mask,.layer0").show();  //显示浮层
        });

        // 勾选选择权限设置
        $(".giftlist .right .active").click(function () {
            // if ($(this).attr('src') === 'img/radio.png') {  //多选择
            //     $(this).attr('src', 'img/active.png');
            //     $(this).attr("data", 0)
            // } else {
            //     $(this).attr('src', 'img/radio.png');
            //     $(this).attr("data", 1)
            // }
            if($(this).attr('src') === 'img/active.png'){
                return;
            }
            $(this).attr('src','img/active.png').parents().siblings().find(".active").attr('src', 'img/radio.png');
        })
    // start点击完成修改设置权限-批量修改
    $(".finish").click(function(){
        //start获取选中的权限
        $(".giftlist .right .active").each(function(index,el){
            if($(this).attr('src') === 'img/active.png'){
                Number=$(this).attr('data');
            }
        })
        //end获取选中的权限

        PermissionList.map(function(item){
            item.permission=Number
            return item;
        })

        var data={
            limitItemAndPermissionVoList:PermissionList,
            protectItemId:protectItemId,
            protectItemType:protectItemType
        }
        console.log(data)
        utils.post({
            url:'/sfs/v1/permission/item' ,
            // type: 'POST',
            data:data,
            dataType: "json",
            contentType: "application/json",
            success: function (result) {
                if (result.returnCode == 0) {
                    permission();
                    $(".mask,.layer0").hide();  //隐藏浮层
                }else{
                    $('.tips_text').text(result.returnMsg);
                    $('.tips').show();
                    $(".mask,.layer0").hide();  //隐藏浮层
                }
            },
            error: function () {
                $('.tips_text').text('系统异常，请稍后再试!');
                $('.tips').show();
                $(".mask,.layer0").hide();  //隐藏浮层
            }
        });
    })
    // end点击完成修改设置权限-批量修改

        $("#showTip").click(function () {
            $(".tips").show();
        })
        // 关闭弹窗
        $(".close,.cancel").click(function () {
            $(".mask,.layer0").hide();
            $(".tips").hide();
        })
})
</script>
</body>
</html>